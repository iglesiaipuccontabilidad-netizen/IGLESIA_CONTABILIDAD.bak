name: Actualizar Votos Vencidos

# ============================================================================
# Workflow: ActualizaciÃ³n AutomÃ¡tica de Votos Vencidos
# PropÃ³sito: Ejecutar diariamente la Edge Function que actualiza votos vencidos
# Frecuencia: Diario a las 00:05 COT (05:05 UTC)
# ============================================================================

on:
  schedule:
    # Ejecutar a las 00:05 hora Colombia (UTC-5) = 05:05 UTC
    - cron: '5 5 * * *'
  
  workflow_dispatch: # Permite ejecuciÃ³n manual desde GitHub UI

jobs:
  actualizar-votos:
    name: Actualizar Votos Vencidos
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“… Log de inicio
        run: |
          echo "ðŸš€ Iniciando actualizaciÃ³n de votos vencidos"
          echo "ðŸ“… Fecha/Hora: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo "ðŸŒ Hora Colombia: $(TZ='America/Bogota' date +"%Y-%m-%d %H:%M:%S COT")"
      
      - name: ðŸ”„ Ejecutar Edge Function
        id: edge-function
        run: |
          echo "ðŸ“¡ Llamando a Edge Function..."
          
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            -H "Content-Type: application/json" \
            https://${{ secrets.SUPABASE_PROJECT_REF }}.supabase.co/functions/v1/actualizar-votos-vencidos)
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)
          BODY=$(echo "$RESPONSE" | head -n -1)
          
          echo "ðŸ“Š CÃ³digo de respuesta: $HTTP_CODE"
          echo "ðŸ“‹ Respuesta:"
          echo "$BODY" | jq '.' || echo "$BODY"
          
          # Guardar respuesta para el siguiente step
          echo "$BODY" > response.json
          echo "http_code=$HTTP_CODE" >> $GITHUB_OUTPUT
          
          # Verificar si fue exitoso
          if [ "$HTTP_CODE" != "200" ]; then
            echo "âŒ Error: La funciÃ³n retornÃ³ cÃ³digo $HTTP_CODE"
            exit 1
          fi
      
      - name: ðŸ“Š Analizar resultados
        if: success()
        run: |
          VOTOS_ACTUALIZADOS=$(cat response.json | jq -r '.votos_actualizados')
          MESSAGE=$(cat response.json | jq -r '.message')
          DURATION=$(cat response.json | jq -r '.duration_ms')
          
          echo "âœ… EjecuciÃ³n exitosa"
          echo "ðŸ“ˆ Votos actualizados: $VOTOS_ACTUALIZADOS"
          echo "â±ï¸  DuraciÃ³n: ${DURATION}ms"
          echo "ðŸ’¬ Mensaje: $MESSAGE"
          
          if [ "$VOTOS_ACTUALIZADOS" -gt 0 ]; then
            echo "ðŸŽ‰ Se actualizaron $VOTOS_ACTUALIZADOS voto(s)"
            echo "ðŸ“‹ IDs:"
            cat response.json | jq -r '.votos_ids[]' | while read id; do
              echo "   â€¢ $id"
            done
          else
            echo "â„¹ï¸  No habÃ­a votos para actualizar"
          fi
      
      - name: âŒ Reportar error
        if: failure()
        run: |
          echo "ðŸ’¥ Error al ejecutar la actualizaciÃ³n"
          echo "ðŸ“‹ Detalles del error:"
          cat response.json 2>/dev/null || echo "No se pudo obtener respuesta"
          
          # AquÃ­ puedes agregar notificaciones (Slack, Email, etc.)
          echo "âš ï¸  Revisar logs de Supabase Edge Functions"
          echo "ðŸ”— Dashboard: https://app.supabase.com/project/${{ secrets.SUPABASE_PROJECT_REF }}/functions"
      
      - name: ðŸ“ Resumen final
        if: always()
        run: |
          echo "============================================"
          echo "ðŸ“Š RESUMEN DE EJECUCIÃ“N"
          echo "============================================"
          echo "ðŸ• Fecha: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo "ðŸŒ Colombia: $(TZ='America/Bogota' date +"%Y-%m-%d %H:%M:%S COT")"
          echo "ðŸ“¡ Workflow: ${{ github.workflow }}"
          echo "ðŸ”„ Run ID: ${{ github.run_id }}"
          echo "âœ… Estado: ${{ job.status }}"
          echo "============================================"

# ============================================================================
# ConfiguraciÃ³n de Secrets Requeridos (GitHub Repository Settings)
# ============================================================================
# 
# 1. CRON_SECRET
#    - DescripciÃ³n: Token de autenticaciÃ³n para la Edge Function
#    - Valor: [El mismo usado en Supabase secrets]
#    - GeneraciÃ³n: openssl rand -base64 32
#
# 2. SUPABASE_PROJECT_REF
#    - DescripciÃ³n: ID del proyecto de Supabase
#    - Valor: [El ID visible en la URL del dashboard]
#    - Ejemplo: abcdefghijklmnop
#
# ============================================================================
# Para configurar en GitHub:
# 1. Ve a: Settings > Secrets and variables > Actions
# 2. Click en "New repository secret"
# 3. Agrega ambos secrets
# ============================================================================
